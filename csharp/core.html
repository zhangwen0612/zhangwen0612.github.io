<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ASP.NET Core MVC | Coder Wen</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="styles/index.styl">
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.64524142.css" as="style"><link rel="preload" href="/assets/js/app.c34800d5.js" as="script"><link rel="preload" href="/assets/js/3.cd6cdf97.js" as="script"><link rel="preload" href="/assets/js/1.3c6da144.js" as="script"><link rel="preload" href="/assets/js/7.5c02c38d.js" as="script"><link rel="prefetch" href="/assets/js/10.0635b80b.js"><link rel="prefetch" href="/assets/js/11.9476e33e.js"><link rel="prefetch" href="/assets/js/12.1dd037b7.js"><link rel="prefetch" href="/assets/js/13.7e35c810.js"><link rel="prefetch" href="/assets/js/14.edae7784.js"><link rel="prefetch" href="/assets/js/15.8cc4bdb1.js"><link rel="prefetch" href="/assets/js/16.c276ddc9.js"><link rel="prefetch" href="/assets/js/17.8409666a.js"><link rel="prefetch" href="/assets/js/18.8b5302e0.js"><link rel="prefetch" href="/assets/js/4.2809b259.js"><link rel="prefetch" href="/assets/js/5.7dac4576.js"><link rel="prefetch" href="/assets/js/6.d66c86da.js"><link rel="prefetch" href="/assets/js/8.2345c2a1.js"><link rel="prefetch" href="/assets/js/9.a24d5e8c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.64524142.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Coder Wen</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc></p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Coder Wen</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webfront/html.html" class="nav-link"><i class="undefined"></i>
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/webfront/css.html" class="nav-link"><i class="undefined"></i>
  CSS3
</a></li><li class="dropdown-item"><!----> <a href="/webfront/js.html" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/webfront/vue.html" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      .NET
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/csharp/cshape/" class="nav-link"><i class="undefined"></i>
  C#基础
</a></li><li class="dropdown-item"><!----> <a href="/csharp/mvc/" class="nav-link"><i class="undefined"></i>
  ASP.NET MVC
</a></li><li class="dropdown-item"><!----> <a href="/csharp/core/" class="nav-link"><i class="undefined"></i>
  ASP.NET Core MVC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      人才库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/student/keda/" class="nav-link"><i class="undefined"></i>
  河南科技大学
</a></li><li class="dropdown-item"><!----> <a href="/student/luozhi/" class="nav-link"><i class="undefined"></i>
  洛阳职业技术学院
</a></li></ul></div></div><div class="nav-item"><a href="/csharp/.html" class="nav-link"><i class="undefined"></i>
  面试
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/lg.png" alt="author-avatar" class="personal-img" data-v-828910c6> <!----> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>5</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>0</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webfront/html.html" class="nav-link"><i class="undefined"></i>
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/webfront/css.html" class="nav-link"><i class="undefined"></i>
  CSS3
</a></li><li class="dropdown-item"><!----> <a href="/webfront/js.html" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/webfront/vue.html" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      .NET
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/csharp/cshape/" class="nav-link"><i class="undefined"></i>
  C#基础
</a></li><li class="dropdown-item"><!----> <a href="/csharp/mvc/" class="nav-link"><i class="undefined"></i>
  ASP.NET MVC
</a></li><li class="dropdown-item"><!----> <a href="/csharp/core/" class="nav-link"><i class="undefined"></i>
  ASP.NET Core MVC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      人才库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/student/keda/" class="nav-link"><i class="undefined"></i>
  河南科技大学
</a></li><li class="dropdown-item"><!----> <a href="/student/luozhi/" class="nav-link"><i class="undefined"></i>
  洛阳职业技术学院
</a></li></ul></div></div><div class="nav-item"><a href="/csharp/.html" class="nav-link"><i class="undefined"></i>
  面试
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>ASP.NET Core MVC</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><!---->
            
          <!---->
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">ASP.NET Core MVC</h1> <div data-v-1ff7123e><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>.NET Framework类库,是微软.NET下提供的一个底层类库，封装了很多类供我们开发。 代码运行在CLR（公共运行平台）。</p> <p>问题：</p> <p>1.CLR和windows系统结合是非常好。在windows平台下都很流畅。</p> <p>2.VisalStido开源, Framework只能运行在window操作系统。</p> <p>随着微软拥抱开源，微软开发了一套全新的框架库，就是.NET Core。</p> <p>.NET Core是全部纯新的一套框架库,支持跨平台，所有操作系统。</p> <p>建议：ASP.NET FW 和ASP.NET CORE如何选择，如果项目是新项目并且对操作系统移植有要求，推荐使用ASP.NET CORE3.X。</p> <p>FW下有很多框架：ASP.NET WebForm, ASP.NET MVC, ASP.NET WebAPI, 窗体应用程序winform</p> <p>Core                    ：ASP.NET Core WebForm   ASP.NET Core MVC  ASP.NET Core WebApi</p> <h2 id="项目结构"><a href="#项目结构" class="header-anchor">#</a> 项目结构</h2> <blockquote><p>appsettings.json</p></blockquote> <p>配置网站信息，例如ConnnectionStrings</p> <blockquote><p>Program</p></blockquote> <p>主入口程序，类似Global中的Application_Start</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IHostBuilder</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=&gt;</span>
   <span class="token punctuation">{</span>
      <span class="token comment">//中间件，注册Startup配置类</span>
      webBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Startup<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>Startup</p></blockquote> <p>用户的注册服务，在该文件中，我们可以以注入的方式来进行相关功能的添加</p> <p>Core支持程序的热加载</p> <p>快捷键ctrl+F5，笔记本有Fn 需要Fn+Ctrl+F5</p> <h2 id="中间件-middleware"><a href="#中间件-middleware" class="header-anchor">#</a> 中间件(Middleware)</h2> <p>中间件是组装到应用程序管道中以处理请求和响应的软件。 每个组件：</p> <ul><li>选择是否将请求传递给管道中的下一个组件。</li> <li>可以在调用管道中的下一个组件之前和之后执行工作。</li></ul> <p>请求委托（Request delegates）用于构建请求管道，处理每个HTTP请求。</p> <p>请求委托使用<code>Run</code>，<code>Map</code>和<code>Use</code>扩展方法进行配置。单独的请求委托可以以内联匿名方法（称为内联中间件）指定，或者可以在可重用的类中定义它。这些可重用的类和内联匿名方法是中间件或中间件组件。请求流程中的每个中间件组件都负责调用流水线中的下一个组件，如果适当，则负责链接短路。</p> <p>ASP.NET Core请求流程由一系列请求委托组成，如图所示</p> <p><img src="/assets/img/668104-20171031100753449-11207087.040d860b.png" alt="668104-20171031100753449-11207087.png"></p> <p>每个委托可以在下一个委托之前和之后执行操作。委托还可以决定不将请求传递给下一个委托，这称为请求管道的短路。短路通常是可取的，因为它避免了不必要的工作。例如，静态文件中间件可以返回一个静态文件的请求，并使管道的其余部分短路。需要在管道早期调用异常处理委托，因此它们可以捕获后面管道的异常。</p> <p>示例：</p> <blockquote><p>中间件使用</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	<span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">&quot;method1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>中间件短路</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	<span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">&quot;method1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	<span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">&quot;method2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//试一试结果是什么</span>
</code></pre></div><p>使用app.Use中间件</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span>next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
     <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">&quot;method1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">&quot;method2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="常用中间件"><a href="#常用中间件" class="header-anchor">#</a> 常用中间件</h2> <p>IConfiguration：配置文件</p> <p>ConfigureServices服务类中间件</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//注入EF SQL服务</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextPool</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
  options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>_configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;StudentDBConnection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//mvc中间件</span>
services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span>EnableEndpointRouting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//IOC容器中间件</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">addTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IStudentRepository<span class="token punctuation">,</span> SQLStudentRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IStudentRepository<span class="token punctuation">,</span> SQLStudentRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IClassesRepository<span class="token punctuation">,</span> SQLClassesRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//中文编码中间件</span>
services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddJsonOptions</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
  options<span class="token punctuation">.</span>JsonSerializerOptions<span class="token punctuation">.</span>Encoder<span class="token operator">=</span>JavaScriptEncoder<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>UnicodeRanges<span class="token punctuation">.</span>All<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Configure服务中，具体配置的中间件</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//开发模式中间件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//静态资源加载中间件</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseDefaultFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用mvc和默认路由中间件</span>
app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span>routers <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    routers<span class="token punctuation">.</span><span class="token function">MapRoute</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;{controller=Home}/{action=List}/{id?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="加载静态资源"><a href="#加载静态资源" class="header-anchor">#</a> 加载静态资源</h2> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="设置初始页"><a href="#设置初始页" class="header-anchor">#</a> 设置初始页</h2> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">FileServerOptions</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileServerOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
options<span class="token punctuation">.</span>DefaultFilesOptions<span class="token punctuation">.</span>DefaultFileNames<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
options<span class="token punctuation">.</span>DefaultFilesOptions<span class="token punctuation">.</span>DefaultFileNames<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseFileServer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="再聊mvc"><a href="#再聊mvc" class="header-anchor">#</a> 再聊MVC</h2> <p>关于Model：通常来说，我们的Model在开发时使用的是ORM，我们可以简单理解为在MVC中的Model负责的是数据的读写和实体类的创建。</p> <p>在DDD（领域驱动设计中），我们将将Model细分整合后合成为了一个叫做Domain（领域）</p> <p>Domain：领域，他的作用是用来存放领域实体、存储、领域服务用的。</p> <p>Domain包括4个部分：</p> <p><strong>Entities:实体</strong></p> <p><img src="/assets/img/image-20210924110754620.02a63a55.png" alt="image-20210924110754620"></p> <p><strong>Policies：接口</strong></p> <p><img src="/assets/img/image-20210924110803436.1394dd6f.png" alt="image-20210924110803436"></p> <p><strong>Repositories:存储库</strong></p> <p><img src="/assets/img/image-20210924110812534.8f3ef705.png" alt="image-20210924110812534"></p> <p><strong>Services:领域服务</strong></p> <h2 id="asp-net-core-mvc使用"><a href="#asp-net-core-mvc使用" class="header-anchor">#</a> ASP.NET Core MVC使用</h2> <p>步骤1：在注入服务中添加MVC组件中间件</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//MVC中间件</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span>EnableEndpointRouting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\
<span class="token punctuation">}</span>
</code></pre></div><p>步骤2：配置MVC路由中间件</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span>routers <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    routers<span class="token punctuation">.</span><span class="token function">MapRoute</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;{controller=Home}/{action=List}/{id?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="viewstart和viewimport"><a href="#viewstart和viewimport" class="header-anchor">#</a> ViewStart和ViewImport</h2> <p>ViewStart：用户设置母版页,可以让页面继承母版页后省略Layout下的路径填写</p> <p>ViewImport:用于统一设置强类型页面中类型的命名空间</p> <h2 id="libman使用"><a href="#libman使用" class="header-anchor">#</a> LibMan使用</h2> <p>客户端（前端）库管理工具，类似npm，微软最新推出的。</p> <p>nuget安装后端插件.dll</p> <h2 id="asp-net-core自带的ioc容器"><a href="#asp-net-core自带的ioc容器" class="header-anchor">#</a> ASP.NET Core自带的IOC容器</h2> <p>IServiceCollection下有三个自带IOC容器可以让我们使用他们分别是：</p> <p>AddSingleton:首次请求会创建一个服务，然后后续请求使用的都是<strong>相同实例</strong>，整个应用程序声明周期中使用该单个实例。</p> <p>AddScoped:在范围内<strong>每个请求</strong>创建一个服务实例，例如在web应用程序中，他为每个http请求创建一个实例，但是同一个web请求中的其他服务在请求的时候，都会使用相同的实例。</p> <p>AddTransient:<strong>每次</strong>请求时，都创建一个<strong>新的服务实例</strong>。</p> <p><img src="/assets/img/image-20210926135408254.be2ab6c6.png" alt="image-20210926135408254"></p> <h2 id="taghelper"><a href="#taghelper" class="header-anchor">#</a> TagHelper</h2> <p>服务器端的组件，可以在Razor文件中创建和渲染HTML元素</p> <p>TagHelper类似于HTML TagHelper</p> <p>内置的TagHelper用于常见任务，例如生成连接，创建表单，加载数据</p> <p>使用步骤：</p> <p>导入</p> <div class="language- extra-class"><pre class="language-text"><code>//_ViewImports.cshtml
@addTagHelper *,Microsoft.AspNetCore.Mvc.TagHelpers
</code></pre></div><p>语法参考：https://blog.csdn.net/Cheng_XZ/article/details/112894788</p> <p><strong>使用TagHelper的优势</strong></p> <p>TagHelper是根据应用程序的路由模板生成的链接，这意味着如果我们更改路由模板，则TagHelper生成的链接会针对路由模板所做的更改自动修改和适配，让生成的链接正常工作。</p> <h2 id="使用orm"><a href="#使用orm" class="header-anchor">#</a> 使用ORM</h2> <p>core中使用EntityFramework</p> <p>步骤：</p> <p>一、安装Microsoft.EntityFrameworkCore.SqlServer -Version 5.0.10</p> <div class="language- extra-class"><pre class="language-text"><code>Install-Package Microsoft.EntityFrameworkCore.SqlServer -Version 5.0.10
</code></pre></div><p>参考：Core ORM全驱动下载地址</p> <p>https://docs.microsoft.com/zh-cn/ef/core/providers/?tabs=dotnet-core-cli</p> <p>二、创建DbContext文件</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppDbContext</span><span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//要将应用程序配置信息传递给DbContext，需要对DbContextOptions进行实例化</span>
    <span class="token keyword">public</span> <span class="token function">AppDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span> Students <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>三、Startup中进行服务注入</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//注入sqlserver服务</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextPool</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
                                            options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>_configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;connString&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="数据迁移"><a href="#数据迁移" class="header-anchor">#</a> 数据迁移</h2> <p>数据迁移是为了让我们数据库架构设计与应用程序的模型类（实体类）保持同步的功能。</p> <p><strong>切记：先安装Install-Package Microsoft.EntityFrameworkCore.Tools</strong></p> <p>迁移命令</p> <div class="language- extra-class"><pre class="language-text"><code>//提供ef core的帮助信息
get-help about_entiryframeworkcore
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>//添加新迁移记录
add-migration
add-migration initialmigration
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>//将数据库更新为指定的迁移
update-database
</code></pre></div><h2 id="种子数据"><a href="#种子数据" class="header-anchor">#</a> 种子数据</h2> <p>初始化</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Student</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            Name <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
            ClassId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            Emali <span class="token operator">=</span> <span class="token string">&quot;30856896@qq.com&quot;</span><span class="token punctuation">,</span>
            Phone <span class="token operator">=</span> <span class="token string">&quot;13803797005&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Student</span>
        <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
            Name <span class="token operator">=</span> <span class="token string">&quot;王五&quot;</span><span class="token punctuation">,</span>
            ClassId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            Emali <span class="token operator">=</span> <span class="token string">&quot;872330790@qq.com&quot;</span><span class="token punctuation">,</span>
            Phone <span class="token operator">=</span> <span class="token string">&quot;13803797005&quot;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="session"><a href="#session" class="header-anchor">#</a> Session</h2> <p>步骤：</p> <p>使用IDistributedcache接口服务启用内存缓存</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token function">AddDistributedMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>调用addsession方法</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token function">AddSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用usesession回调(需在useMvc()方法前调用)</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">UseSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//中间件：配置mvc中的路由</span>
app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span>routers <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    routers<span class="token punctuation">.</span><span class="token function">MapRoute</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;{controller=Student}/{action=List}/{id?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="日志记录nlog"><a href="#日志记录nlog" class="header-anchor">#</a> 日志记录nlog</h2> <p>完整需要对程序的请求过程进行日志记录，常用的日志记录库非常多，例如NLog、Stackdriver、Gelf、Log4net、Logger等。</p> <p>日志记录主要对项目的异常和请求进行捕获记录。</p> <p>以nlog使用步骤为例：</p> <p>安装插件</p> <p>一、通过nuget安装NLog.Web.AspNETCore</p> <p>二、添加配置文件,配置文件内容</p> <p>注意：设置文件属性为“始终复制”</p> <h2 id="filter拦截器"><a href="#filter拦截器" class="header-anchor">#</a> Filter拦截器</h2> <h2 id="authonization-filter"><a href="#authonization-filter" class="header-anchor">#</a> Authonization Filter</h2> <p><strong>权限控制过滤器</strong>
通过 Authonization Filter 可以实现复杂的<code>权限角色认证</code>、<code>登陆授权</code>等操作</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthonizationFilter</span> <span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span><span class="token class-name">IAuthorizationFilter</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnAuthorization</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationFilterContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//这里可以做复杂的权限控制操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name <span class="token operator">!=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token comment">//简单的做一个示范</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//未通过验证则跳转到无权限提示页</span>
                <span class="token class-name">RedirectToActionResult</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedirectToActionResult</span><span class="token punctuation">(</span><span class="token string">&quot;NoAuth&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                context<span class="token punctuation">.</span>Result <span class="token operator">=</span> content<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>Resource Filter资源过滤器</strong>
可以通过Resource Filter 进行<code>资源缓存</code>、<code>防盗链</code>等操作。
使用Resource Filter 要求实现IResourceFilter 抽象接口</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span><span class="token class-name">IResourceFilter</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResourceExecuted</span><span class="token punctuation">(</span><span class="token class-name">ResourceExecutedContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 执行完后的操作</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnResourceExecuting</span><span class="token punctuation">(</span><span class="token class-name">ResourceExecutingContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 执行中的过滤器管道</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>Exception Filter</strong></p> <p>通过Execption Filter 过滤器可以进行全局的<code>异常日志收集</code> 等操作。</p> <p>使用Execption Filter 要求实现<code>IExceptionFilter</code> 抽象接口
<code>IExceptionFilter</code>接口会要求实现<code>OnException</code>方法，当系统发生未捕获异常时就会触发这个方法。<code>OnException</code>方法有一个<code>ExceptionContext</code>异常上下文，其中包含了具体的异常信息，HttpContext及mvc路由信息。系统一旦出现未捕获异常后，比较常见的做法就是使用日志工具，将异常的详细信息记录下来，方便修正调试。下面是日志记录的实现。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecptionFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IExceptionFilter</span></span>
  <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>ExecptionFilter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>
        <span class="token comment">//构造注入日志组件</span>
        <span class="token keyword">public</span> <span class="token function">ExecptionFilter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>ExecptionFilter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//日志收集</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">,</span> context<span class="token punctuation">?.</span>Exception<span class="token punctuation">?.</span>Message<span class="token operator">??</span><span class="token string">&quot;异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>Action Filter,ResultFilter</strong></p> <p><strong>过滤器注册方式</strong></p> <p>一、Action</p> <p>二、Controller</p> <p>三、全局注册方式</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//全局注册异常过滤器</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllersWithViews</span><span class="token punctuation">(</span>option<span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        option<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ExecptionFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISingletonService<span class="token punctuation">,</span> SingletonService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>四、 TypeFilter和ServiceFilter</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecptionFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IExceptionFilter</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>ExecptionFilter<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>
        <span class="token comment">//构造注入日志组件</span>
        <span class="token keyword">public</span> <span class="token function">ExecptionFilter</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>ExecptionFilter<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//日志收集</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">,</span> context<span class="token punctuation">?.</span>Exception<span class="token punctuation">?.</span>Message<span class="token operator">??</span><span class="token string">&quot;异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>从上面的代码中可以发现 ExceptionFilter 过滤器实现中存在日志服务的构造函数的注入，也就是说该过滤器依赖于其他的日志服务，但是日志服务都是通过DI 注入进来的；再来回顾下上面Action 注册方式或者Controller 注册方式 也即<code>Attribute</code> 特性标注注册方式，本身基础的特性是不支持构造函数的，是在运行时注册进来的，那要解决这种本身需要对服务依赖的过滤器需要使用 <code>TypeFilter</code> 或者<code>ServiceFilter</code> 方式进行过滤器的标注注册。</p> <p><code>TypeFilter</code> 和<code>ServiceFilter</code> 的区别。</p> <ul><li>ServiceFilter和TypeFilter都实现了IFilterFactory</li> <li>ServiceFilter需要对自定义的Filter进行注册，TypeFilter不需要</li> <li>ServiceFilter的Filter生命周期源自于您如何注册，而TypeFilter每次都会创建一个新的实例</li></ul> <p><strong>TypeFilter 使用方式</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">TypeFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ExecptionFilter</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionFilter</span> <span class="token function">Index2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ServiceFilter</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ServiceFilter</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ExecptionFilter</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionFilter</span> <span class="token function">Index2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>服务注册代码</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">//注册过滤器服务，使用ServiceFilter 方式必须要注册 否则会报没有注册该服务的相关异常</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ExecptionFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/csharp/core.html#简介" class="sidebar-link reco-side-简介" data-v-70334359>简介</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#项目结构" class="sidebar-link reco-side-项目结构" data-v-70334359>项目结构</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#中间件-middleware" class="sidebar-link reco-side-中间件-middleware" data-v-70334359>中间件(Middleware)</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#常用中间件" class="sidebar-link reco-side-常用中间件" data-v-70334359>常用中间件</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#加载静态资源" class="sidebar-link reco-side-加载静态资源" data-v-70334359>加载静态资源</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#设置初始页" class="sidebar-link reco-side-设置初始页" data-v-70334359>设置初始页</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#再聊mvc" class="sidebar-link reco-side-再聊mvc" data-v-70334359>再聊MVC</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#asp-net-core-mvc使用" class="sidebar-link reco-side-asp-net-core-mvc使用" data-v-70334359>ASP.NET Core MVC使用</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#viewstart和viewimport" class="sidebar-link reco-side-viewstart和viewimport" data-v-70334359>ViewStart和ViewImport</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#libman使用" class="sidebar-link reco-side-libman使用" data-v-70334359>LibMan使用</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#asp-net-core自带的ioc容器" class="sidebar-link reco-side-asp-net-core自带的ioc容器" data-v-70334359>ASP.NET Core自带的IOC容器</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#taghelper" class="sidebar-link reco-side-taghelper" data-v-70334359>TagHelper</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#使用orm" class="sidebar-link reco-side-使用orm" data-v-70334359>使用ORM</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#数据迁移" class="sidebar-link reco-side-数据迁移" data-v-70334359>数据迁移</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#种子数据" class="sidebar-link reco-side-种子数据" data-v-70334359>种子数据</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#session" class="sidebar-link reco-side-session" data-v-70334359>Session</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#日志记录nlog" class="sidebar-link reco-side-日志记录nlog" data-v-70334359>日志记录nlog</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#filter拦截器" class="sidebar-link reco-side-filter拦截器" data-v-70334359>Filter拦截器</a></li><li class="level-2" data-v-70334359><a href="/csharp/core.html#authonization-filter" class="sidebar-link reco-side-authonization-filter" data-v-70334359>Authonization Filter</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.c34800d5.js" defer></script><script src="/assets/js/3.cd6cdf97.js" defer></script><script src="/assets/js/1.3c6da144.js" defer></script><script src="/assets/js/7.5c02c38d.js" defer></script>
  </body>
</html>
